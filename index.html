<!DOCTYPE html>
<html>
    <head>
        <title>Page Title</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <link href="./common.css" rel="stylesheet" />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://kit.fontawesome.com/4b54ff36e2.js"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <div id="dist">
            <div>
                <button type="button" class="btn btn-primary" @click="reset">
                    초기화
                </button>
                <div
                    style="float: right; opacity: 0"
                    ondblclick="location.href = './me.html'"
                >
                    345
                </div>
            </div>
            <div class="underline" style="opacity: 0"></div>
            <div class="section_small">
                <div class="boss-input" v-for="{id, name} in boss">
                    <h5 class="mb-3">{{name}}</h5>
                    <div class="bossItem text-center mb-5">
                        <div v-for="j in 4">
                            <div class="row">
                                <div
                                    class="col icon icon_1"
                                    v-for="k in 4"
                                    :style="'background: url(./images/'+items[(j*4)+k-5]+'.png) no-repeat center'"
                                ></div>
                            </div>
                            <div class="row last">
                                <div class="num col" v-for="k in 4">
                                    <div @click="numChange(-1, id, j, k)">
                                        <i class="fa-solid fa-minus"></i>
                                    </div>
                                    <div>{{count[id][items[(j*4)+k-5]]}}</div>
                                    <div @click="numChange(1, id, j, k)"><i class="fa-solid fa-plus"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="underline"></div>
            <h5 class="mb-3">시세</h5>
            <div class="section_2line">
                <div class="price-input" v-for="(i, index) in items">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">
                            <span
                                class="icon icon_2"
                                :style="'background: url(./images/'+i+'.png) no-repeat center'"
                            ></span>
                        </span>

                        <input
                            type="number"
                            :class="'form-control '+(existYn[i]?'exist':'')"
                            v-model="price[i]"
                        />
                    </div>
                    <div class="unit" v-if="price[i] && price[i].length > 0">
                        {{getUnit(price[i])}}
                    </div>
                </div>
            </div>
            <div class="underline"></div>
            <div class="section_small">
                <div class="boss-input">
                    <h5 class="mb-3">인원수</h5>
                    <div class="bossItem text-center mb-3">
                        <div>
                            <div class="row">
                                <div class="col" v-for="{id, name} in boss">
                                    {{name}}
                                </div>
                            </div>
                            <div class="row last">
                                <div class="num col" v-for="{id, name} in boss">
                                    <div @click="peopleChange(-1, id)"><i class="fa-solid fa-minus"></i></div>
                                    <div>{{people[id]}}</div>
                                    <div @click="peopleChange(1, id)"><i class="fa-solid fa-plus"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="underline"></div>
            <div class="section_small eq">
                <div class="eq-input">
                    <h5 class="mb-3">장비</h5>
                    <div
                        class="eq-item text-center mb-3"
                        v-for="(eq, index) in eqs"
                    >
                        <div class="eq-name">
                            <label>
                                <span class="eq-edit"
                                    ><i class="fa-solid fa-pen"></i
                                ></span>
                                <input
                                    type="text"
                                    class="eq-name-input"
                                    v-model="eqs[index].tag"
                                />
                            </label>
                        </div>
                        <div class="input-group mb-2">
                            <select
                                class="form-select"
                                v-model="eqs[index].boss"
                            >
                                <option v-for="{id, name} in boss" :value="id">
                                    {{name}}
                                </option>
                            </select>
                            <input
                                type="number"
                                class="form-control eq-price"
                                placeholder="가격"
                                v-model="eqs[index].price"
                            />
                            <input
                                type="number"
                                class="form-control eq-num"
                                placeholder="인원"
                                v-model="eqs[index].num"
                            />
                            <button
                                type="button"
                                class="btn btn-danger form-control"
                                @click="deleq(index)"
                            >
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div
                            class="unit"
                            v-if="eqs[index].price && eqs[index].price.length > 0"
                        >
                            {{getUnit(eqs[index].price)}}
                        </div>
                    </div>
                    <div>
                        <button
                            type="button"
                            class="btn btn-primary form-control"
                            @click="addeq"
                        >
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="underline"></div>
            <h5 class="mb-3">
                분배
                <span class="round">
                    <div class="round-label">반올림</div>
                    <select class="form-select" v-model="round">
                        <option v-for="i in 8">{{10**(i-1)}}</option>
                    </select>
                </span>
            </h5>
            <div>
                <div class="total-box">
                    <div class="text-center">챤</div>
                    <div>{{getTotal(['lucid'])}}</div>
                </div>
                <div class="total-box">
                    <div class="text-center">문겐</div>
                    <div>{{getTotal(['dusle'])}}</div>
                </div>
                <div class="total-box">
                    <div class="text-center">숍님</div>
                    <div>{{getTotal(['sdedune', 'dusle'])}}</div>
                </div>
                <div class="total-box">
                    <div class="text-center">앙크</div>
                    <div>{{getTotal(['lucid', 'will', 'dusle'])}}</div>
                </div>
                <div class="total-box">
                    <div class="text-center">나머지</div>
                    <div>
                        {{getTotal(['lucid', 'will', 'sdedune', 'dusle'])}}
                    </div>
                </div>
            </div>
            <div class="underline"></div>
            <h5 class="mb-3">각각</h5>
            <div>
                <div
                    :class="'total-box '+(selected.includes(key)?'exist':'')"
                    v-for="(value, key) in totalEach"
                    @click="toggle(key)"
                >
                    <div class="text-center">{{value.name}}</div>
                    <div>{{getFormat(value.total)}}</div>
                </div>
                <div class="total-box real-total">
                    <div class="text-center">총합</div>
                    <div>{{getFormat(realTotal)}}</div>
                </div>
            </div>
        </div>
    </body>
    <script>
        var dist = new Vue({
            el: "#dist",
            data: {
                price: {},
                selected: [],
                people: {
                    lucid: 5,
                    will: 4,
                    sdedune: 4,
                    dusle: 6,
                },
                eqs: [],
                count: {},
                round: 10000,
                items: [
                    "extra",
                    "small",
                    "red",
                    "blue",
                    "addcube",
                    "honor",
                    "flame",
                    "forflame",
                    "darkflame",
                    "rein",
                    "forrein",
                    "darkrein",
                    "pos",
                    "scroll",
                    "pscroll",
                    "ess",
                ],
                boss: [
                    { id: "lucid", name: "루시드" },
                    { id: "will", name: "윌" },
                    { id: "sdedune", name: "스데듄" },
                    { id: "dusle", name: "더슬" },
                ],
            },
            computed: {
                existYn() {
                    const exist = {};
                    if (this.count.lucid.addcube) {
                        for (let i in this.count) {
                            for (let j in this.count[i]) {
                                if (this.count[i][j] > 0 && !exist[j])
                                    exist[j] = true;
                            }
                        }
                    }
                    return exist;
                },
                total() {
                    const tot = {};
                    if (this.count.lucid.addcube) {
                        for (let i in this.count) {
                            var bunbae = 0;
                            for (let j in this.count[i]) {
                                bunbae +=
                                    this.count[i][j] *
                                    (this.price[j] || this.price[j] == ""
                                        ? this.price[j]
                                        : 0);
                            }
                            bunbae *= this.getDiv(this.people[i]);
                            for (let j of this.eqs) {
                                if (
                                    j.boss === i &&
                                    j.price != "" &&
                                    j.num != ""
                                ) {
                                    bunbae += j.price * this.getDiv(j.num);
                                }
                            }
                            tot[i] = bunbae;
                        }
                    }
                    return tot;
                },
                totalEach() {
                    const tot = {};
                    if (this.count.lucid.addcube) {
                        for (let i in this.count) {
                            var bunbae = 0;
                            for (let j in this.count[i]) {
                                bunbae +=
                                    this.count[i][j] *
                                    (this.price[j] || this.price[j] == ""
                                        ? this.price[j]
                                        : 0);
                            }
                            bunbae *= this.getDiv(this.people[i]);
                            let name = this.boss.filter((a) => a.id === i)[0]
                                .name;
                            tot[i] = {
                                name: name,
                                total: bunbae,
                            };
                        }
                        var n = {};
                        for (let i of this.boss) {
                            n[i.id] = 1;
                        }
                        for (let i of this.eqs) {
                            var bunbae = 0;
                            if (i.price != "" && i.num != "") {
                                bunbae += i.price * this.getDiv(i.num);
                            }
                            tot['eq'+i.index] = {
                                name: i.tag,
                                total: bunbae,
                            };
                            n[i.boss] += 1;
                        }
                    }
                    return tot;
                },
                realTotal() {
                    var sum = 0;
                    var that = this;
                    this.selected.forEach((a) => {
                        sum += that.totalEach[a].total;
                    });
                    return sum;
                },
            },
            watch: {
                price: {
                    handler(val, oldVal) {
                        localStorage["price"] = JSON.stringify(val);
                    },
                    deep: true,
                },
                people: {
                    handler(val, oldVal) {
                        localStorage["people"] = JSON.stringify(val);
                    },
                    deep: true,
                },
                eqs: {
                    handler(val, oldVal) {
                        localStorage["eqs"] = JSON.stringify(val);
                    },
                    deep: true,
                },
            },
            methods: {
                reset() {
                    localStorage.clear();
                    location.reload();
                },
                numChange(type, i, j, k) {
                    if (this.count) {
                        this.count = {
                            ...this.count,
                            [i]: {
                                ...this.count[i],
                                [this.items[j * 4 + k - 5]]:
                                    this.count[i][this.items[j * 4 + k - 5]] +
                                        type >=
                                    0
                                        ? this.count[i][
                                              this.items[j * 4 + k - 5]
                                          ] + type
                                        : 0,
                            },
                        };
                    }
                    localStorage["count"] = JSON.stringify(this.count);
                },
                getUnit(n) {
                    n = n.toString();
                    var r = this.getReverse(n);
                    var part = [];
                    var units = ["만", "억", "조"];
                    for (let i = 0; i < r.length / 4; i++) {
                        part.push(r.substr(i * 4, 4));
                    }
                    var u = "";
                    for (let i = 0; i < part.length; i++) {
                        u += part[i] + (i != part.length - 1 ? units[i] : "");
                    }
                    return this.getReverse(u);
                },
                getReverse(n) {
                    var r = "";
                    for (let i = 1; i <= n.length; i++) {
                        r += n[n.length - i];
                    }
                    return r;
                },
                getTotal(arr) {
                    var total = 0;
                    for (let i of arr) {
                        total += this.total[i];
                    }
                    return this.getFormat(total);
                },
                getFormat(n) {
                    n = n.toString();
                    return (Math.ceil(n / this.round) * this.round)
                        .toString()
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },
                getDiv(n) {
                    return 95 / (100 * n - 5);
                },
                peopleChange(type, i) {
                    if (this.people) {
                        this.people = {
                            ...this.people,
                            [i]:
                                this.people[i] + type >= 0
                                    ? this.people[i] + type
                                    : 0,
                        };
                    }
                },
                addeq() {
                    this.eqs.push({
                        boss: this.boss[0].id,
                        price: "",
                        num: "",
                        tag:
                            "장비" +
                            (this.eqs.reduce(
                                (total, value) =>
                                    total > value.index ? total : value.index,
                                0
                            ) +
                                1),
                        index:
                            this.eqs.reduce(
                                (total, value) =>
                                    total > value.index ? total : value.index,
                                0
                            ) + 1,
                    });
                },
                deleq(i) {
                    this.eqs.splice(i, 1);
                },
                toggle(k) {
                    if (this.selected.includes(k)) {
                        this.selected = this.selected.filter((a) => a != k);
                    } else this.selected.push(k);
                },
            },
            created() {
                if (localStorage.getItem("price")) {
                    this.price = JSON.parse(localStorage.getItem("price"));
                }
                if (localStorage.getItem("people")) {
                    this.people = JSON.parse(localStorage.getItem("people"));
                }
                if (localStorage.getItem("eqs")) {
                    this.eqs = JSON.parse(localStorage.getItem("eqs"));
                }
                if (localStorage.getItem("count")) {
                    this.count = JSON.parse(localStorage.getItem("count"));
                } else {
                    for (let i of this.boss) {
                        var cnt = {};
                        for (let j of this.items) {
                            if (j === "addcube") {
                                if (i.id === "lucid") cnt[j] = 9;
                                else if (i.id === "will") cnt[j] = 9;
                                else if (i.id === "sdedune") cnt[j] = 36;
                                else if (i.id === "dusle") cnt[j] = 19;
                            } else cnt[j] = 0;
                        }
                        this.count[i.id] = cnt;
                    }
                }
            },
        });
    </script>
</html>
